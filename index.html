<html>
  <body>
    <script type="text/javascript">

/**
 * Calculates the buffers CRC16.
 *
 * @param {Buffer} buffer the data buffer.
 * @return {number} the calculated CRC16.
 * 
 * Source: github.com/yaacov/node-modbus-serial
 */
 function crc16(buffer) {
    var crc = 0xFFFF;
    var odd;

    for (var i = 0; i < buffer.length; i++) {
        crc = crc ^ buffer[i];

        for (var j = 0; j < 8; j++) {
            odd = crc & 0x0001;
            crc = crc >> 1;
            if (odd) {
                crc = crc ^ 0xA001;
            }
        }
    }

    return crc;
};

    async function connect() {
      let filters = [{ vendorId: 0x2e3c, productId: 0xaf01 }];
      let requestParams = { filters };
      let outputReportId = 0x01;
      let outputReport = new Uint8Array([42]);

      function handleConnectedDevice(e) {
        console.log("Device connected: " + e.device.productName);
      }

      function handleDisconnectedDevice(e) {
        console.log("Device disconnected: " + e.device.productName);
      }

      function handleInputReport(e) {
        console.log(e.device.productName + ": got input report " + e.reportId);
        const frameData = new Uint8Array(e.data.buffer)
        console.log(frameData);
        const frameDv = new DataView(frameData.buffer, frameData.byteOffset, frameData.byteLength)

        const dataLen = frameDv.getUint8(3);
        const frame = {
            deviceAddr: frameDv.getUint8(0),
            functionType: frameDv.getUint8(1),
            sequence: frameDv.getUint8(2),
            dataLen,
            data: frameData.slice(4, 4 + dataLen),
            checksum: frameDv.getUint16(4 + dataLen, true)
        }
        console.log('got frame', frame)
        const computedChecksum = crc16(frameData.slice(0, 4 + dataLen))
        if (computedChecksum !== frame.checksum) {
            console.warn('checksum mismatch in received frame', { expected: computedChecksum })
        }

        if (frame.functionType === FRAME_FUNC.FRAME_BASIC_INFO) {
            const dataDv = new DataView(new Uint8Array(frame.data).buffer, 0, frame.dataLen)
            const basicInfo = {
                vin: dataDv.getUint16(0, true),
                vout: dataDv.getUint16(2, true),
                iout: dataDv.getUint16(4, true),
                vo_max: dataDv.getUint16(6, true),
                temp1: dataDv.getUint16(8, true),
                temp2: dataDv.getUint16(10, true),
                dc_5V: dataDv.getUint16(12, true),
                out_mode: dataDv.getUint8(14),
                work_st: dataDv.getUint8(15),
            }
            console.log('basic info', basicInfo)
        }
      }

      navigator.hid.addEventListener("connect", handleConnectedDevice);
      navigator.hid.addEventListener("disconnect", handleDisconnectedDevice);

      const devices = await navigator.hid.requestDevice(requestParams)
        if (devices.length == 0) return;
        const device = devices[0];

        // TODO: handle exception here; recommend checking permissions (udev on linux)
        await device.open()
        
          console.log("Opened device", device);
          device.addEventListener("inputreport", handleInputReport);

        const FRAME_FUNC = {
            FRAME_DEVICE_INFO: 0x10,
            FRAME_FIRM_INFO: 17,
            FRAME_START_TRANS: 18,
            FRAME_DATA_TRANS: 19,
            FRAME_END_TRANS: 20,
            FRAME_DEV_UPGRADE: 21,
            FRAME_BASIC_INFO: 48,
            FRAME_BASIC_SET: 53,
            FRAME_SYSTEM_INFO: 0x40,
            FRAME_SYSTEM_SET: 69,
            FRAME_SCAN_OUT: 80,
            FRAME_SERIAL_OUT: 85,
            FRAM_DISCONNECT: 0x80,
            NONE: 0xFF,
        }

        // construct GetBasic frame
        const frameData = []
        const frame = {
            deviceAddr: 251,
            functionType: FRAME_FUNC.FRAME_BASIC_INFO,
            sequence: 0,
            dataLen: frameData.length,
            data: frameData,
            // checksum added later
        }
        const frameBuffer = new Uint8Array([
            frame.deviceAddr,
            frame.functionType,
            frame.sequence,
            frame.dataLen,
            ...frame.data,
            0,
            0,
        ]);
        // checksum
        // NB: I'm not sure the checksum is being checked?
        const checksum = crc16(frameBuffer.slice(0, frameBuffer.length - 2))
        const frameBufferDv = new DataView(frameBuffer.buffer, frameBuffer.byteOffset, frameBuffer.byteLength)
        frameBufferDv.setUint16(frameBuffer.length - 2, checksum, true); // little-endian
        console.log('FrameEntity', frameBuffer)

        const requestBasicInfo = async () => {
          await device.sendReport(0, frameBuffer);
          setTimeout(requestBasicInfo, 5000);
        }
        requestBasicInfo()
        //   device.sendReport(outputReportId, outputReport).then(() => {
        //     console.log("Sent output report " + outputReportId);
        //   });
    }
    </script>
    <button onclick="connect()">Connect</button>
    See console!
  </body>
</html>
